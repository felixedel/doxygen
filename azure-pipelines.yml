trigger:
  - master

pr:
  - master

pool:
  vmImage: 'ubuntu-18.04'
    
variables:
  buildDir: '$(System.DefaultWorkingDirectory)/build'

stages:
- stage: build_and_test
  jobs:
  - job: build_doxygen
    steps:
    - script: |
        sudo apt-get update \
        && sudo apt-get install -y \
          build-essential \
          cmake \
          flex \
          bison \
          libxml2-utils \
          texlive-base \
          python
      displayName: install_deps
    - task: CMake@1
      inputs:
        workingDirectory: $(buildDir)
        cmakeArgs: $(Build.SourcesDirectory)
      displayName: configure
    - task: CMake@1
      inputs:
        workingDirectory: $(buildDir)
        cmakeArgs: --build .
      displayName: make
    - script: ctest --output-on-failure --no-compress-output -T Test
      continueOnError: true
      workingDirectory: $(buildDir)
      displayName: ctest
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: cTest
        testResultsFiles: '**/Test.xml'
        searchFolder: $(buildDir)/Testing
    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: $(buildDir)/bin
        artifactName: doxygen
