# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Use a package of configuration called an orb.
orbs:
  # Declare a dependency on the welcome-orb
  welcome: circleci/welcome-orb@0.4.1

jobs:
  build-doxygen:
    docker:
      - image: schanzel/doxygen-build-env:latest
    steps:
      - checkout
      - run:
          name: Creating build files
          command: 'cmake -H. -Bbuild'
      - run:
          name: Creating binary files
          command: 'cmake --build build'
      - persist_to_workspace:
          name: Persist build dir to workspace
          root: .
          paths:
            - build
  test-doxygen:
    docker:
      - image: schanzel/doxygen-build-env:latest
    steps:
      - checkout
      - attach_workspace:
          name: Restore build dir from workspace
          at: .
      - run:
          name: Run tests
          command: ctest --output-on-failure --no-compress-output -T Test
          working_directory: build
      - persist_to_workspace:
          name: Persist test results to workspace
          root: .
          paths:
            - build/Testing
  upload-tests:
    docker:
      - image: cimg/base:2020.01
    steps:
      - attach_workspace:
          name: Restore test results from workspace
          at: .
      - store_test_results:
          name: Upload test results
          path: build/Testing
  upload-artifacts:
    docker:
      - image: cimg/base:2020.01
    steps:
      - attach_workspace:
          name: Restore build results from workspace
          at: .
      - store_artifacts:
          name: Upload build artifacts
          path: build/bin
          destination: doxygen

# Orchestrate or schedule a set of jobs
workflows:
  # Name the workflow "welcome"
  welcome:
    # Run the welcome/run job in its own container
    jobs:
      - welcome/run
      - build-doxygen
      - test-doxygen:
          requires:
            - build-doxygen
      - upload-tests:
          requires:
            - test-doxygen
      - upload-artifacts:
          requires:
            - test-doxygen
